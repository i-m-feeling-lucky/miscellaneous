# 概要设计说明书

<!-- TOC -->

- [简介](#简介)
  - [目的](#目的)
  - [范围](#范围)
    - [软件名称](#软件名称)
    - [软件功能](#软件功能)
    - [软件应用](#软件应用)
  - [实现系统环境](#实现系统环境)
    - [开发环境](#开发环境)
    - [测试环境](#测试环境)
    - [运行环境-客户端](#运行环境-客户端)
    - [运行环境-服务器端](#运行环境-服务器端)
  
- [概要设计](#概要设计)
  - [处理流程](#处理流程)
  - [前端设计](#前端设计)
    - [界面设计](#界面设计)
    - [功能设计：面试房间](#功能设计：面试房间)
    - [其他](#其他)
    - [详细设计](#详细设计)
  - [数据库设计](#数据库设计)
    - [`User`](#user)
      - [`Interviewer`](#interviewer)
    - [`UserLogin`](#userlogin)
    - [`Interviewee`](#interviewee)
    - [`HRAssignInterviewer`](#hrassigninterviewer)
    - [`HRAssignInterviewee`](#hrassigninterviewee)
    - [`Interview`](#interview)
    - [`InterviewComment`](#interviewcomment)
    - [`History`](#history)
    - [`Problem`](#problem)
  - [接口设计](#接口描述)
  - [维护设计](#维护设计)
    - [备份](#备份)
    - [维护窗口期](#维护窗口期)

<!-- /TOC -->

## 简介

### 目的

主要基于以下目的编写此说明书：

1. 对系统概要设计的阶段任务结果形成文档，以便阶段验收、评审、最终文档的验收；
2. 对需求阶段的文档再次确认过程，对前一阶段需求错误或没有做充分的地方提出修改；
3. 明确整个系统的功能框架和数据库结构，为下一阶段的详细设计、编码和测试提供参考依据；
4. 明确编码规范和命名规范，统一程序界面。

预期读者：参与详细设计的人员、软件工程任课老师及助教。



### 范围

#### 软件名称

LUCKY在线面试平台

#### 软件功能

##### 前端主要功能

- 为用户提供友好的操作接口

- 为不同类型用户提供不同的操作界面及功能

  - 超管
    - 有账号，需要登录；
    - 添加 HR、面试官、候选人（可以从 CSV 文件、Excel 文件导入）；
    - 给 HR 分配候选人、可用的面试官。

  - HR
    - 有账号，需要登录；
    - 可以分配候选人给面试官并指定面试时长；
    - 可以从面试官获得对候选人的评价，并根据面试官的评价等级和评语，进行总评（录用、拒绝、进入下一轮）；
    - 可旁观面试；
    - 可回溯面试过程（看到面试过程的文字聊天、白板、代码、视频）。

  - 面试官
    - 有账号，需要登录；
    - 可以在系统里面填入自己的空闲时间，服从 HR 的安排；
    - 在评价框常驻，可在面试过程中对候选人进行评价（等级、评语）；
    - 可以结束面试。
      - 当面试被系统强制结束（超时 10min 或这个面试官距离 TA 的下个面试不足 10min），若这个时刻面试官在线，面试官可继续编辑评价，编辑完之后点击”提交评价“，若这个时刻面试官不在线（面试官一直迟到到现在或面试官面试了一段时间，但是没有结束面试就提前离去），那么自动提交评价框的评价；
      - 当面试不是被强制结束（双方约定好提前结束或候选人迟到且面试官不想再等），若面试官的评价已经写好，可以直接点击”提交评价并结束面试“，若还没写完，可以先点击“结束面试”，此时可以继续编辑评价，编辑完之后点击“提交评价”。

  - 候选人
    - 通过邮件收到面试通知，包含面试详情、进入面试房间的安全链接。

##### 后端主要功能

- 在服务器运行驻留

- 接收并处理前端网络请求

- 检查请求的正确性和合法性，保证操作的安全性

- 根据请求事务同步更新数据库状态

  

#### 软件应用

疫情之下，各地实行封闭式管理，公共交通限制运行，对企业的招聘和求职者的应聘带来了极大的不便利，视频面试也在替代传统线下面试，正成为当下的刚需。在防控疫情的情况下，研究生招生复试、艺术类考生招生学校现场考试、综合素质评价学校面试等，都可尝试采取“云面试”的方式来进行，这不仅仅是替代当前无法开展的线下面试，而且可以为推进招生改革探索成本更低且能保障公信力的面试方式助力。

本软件能够满足企业通过远程视频等手段招聘人才，以及学校使用“云面试”选拔学生的需求。



### 实现系统环境

#### 开发环境

| 类别       | 标准配置                                                     | 最低配置                                                     |
| ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 计算机硬件 | 基于x86结构的CPU<br />主频>=2.4GHz<br />内存>=8GB<br />硬盘>=200GB | 基于x86结构的CPU<br />主频>=1.6GHz<br />内存>=4GB<br />硬盘>=20GB |
| 计算机软件 | Ubuntu 16.04<br />Vue.js 2.9<br />python 3.6<br />Node v12<br />MySQL | Ubuntu 16.04<br />Vue.js 2.6<br />python 3.6<br />Node v12<br />MySQL |
| 网络通信   | 可用网卡数量>=1<br />能运行IP协议栈                          | 可用网卡数量>=1<br />能运行IP协议栈                          |

#### 测试环境

| 类别       | 标准配置                                                     | 最低配置                                                     |
| ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 计算机硬件 | 基于x86结构的CPU<br />主频>=2.4GHz<br />内存>=4GB<br />硬盘>=80GB | 基于x86结构的CPU<br />主频>=1.6GHz<br />内存>=2GB<br />硬盘>=40GB |
| 计算机软件 | Ubuntu 16.04<br />Vue.js 2.9<br />python 3.6<br />Node v12<br />MySQL<br />浏览器完全支持HTML5, CSS3, ECMAScript 5 | Ubuntu 16.04<br />Vue.js 2.6<br />python 3.6<br />Node v12<br />MySQL<br />浏览器完全支持HTML5, CSS3, ECMAScript 5 |
| 网络通信   | 可用网卡数量>=1<br />能运行IP协议栈                          | 可用网卡数量>=1<br />能运行IP协议栈                          |

#### 运行环境-客户端

| 类别       | 标准配置                                                     | 最低配置                                                     |
| ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 计算机硬件 | 基于x86结构的CPU<br />主频>=2.4GHz<br />内存>=2GB<br />可用硬盘空间>=20GB | 基于x86结构的CPU<br />主频>=1.6GHz<br />内存>=1GB<br />可用硬盘空间>=10GB |
| 计算机软件 | 浏览器完全支持HTML5, CSS3, ECMAScript 5                      | 浏览器完全支持HTML5, CSS3, ECMAScript 5                      |
| 网络通信   | 可用网卡数量>=1<br />能运行IP协议栈<br />至少10兆宽带接入    | 可用网卡数量>=1<br />能运行IP协议栈<br />至少10兆宽带接入    |

#### 运行环境-服务器端

| 类别       | 标准配置                                                     | 最低配置                                                     |
| ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 计算机硬件 | 基于x86结构的CPU<br />主频>=2.4GHz<br />内存>=4GB<br />硬盘>=80GB | 基于x86结构的CPU<br />主频>=1.8GHz<br />内存>=2GB<br />硬盘>=40GB |
| 计算机软件 | Linux(kernel version >= 4.4)<br />python 3.6<br />MySQL      | Linux(kernel version >= 4.4)<br />python 3.6<br />MySQL      |
| 网络通信   | 可用网卡数量>=1<br />能运行IP协议栈<br />至少百兆宽带接入    | 可用网卡数量>=1<br />能运行IP协议栈<br />至少10兆宽带接入    |



## 概要设计

### 处理流程

![](软件流程图.jpg)

### 前端设计

根据面试平台的需求，前端部分主要由管理平台和面试房间组成，其中管理平台模块用于超管、HR 和面试官管理整个面试平台；面试房间模块用于面试官面试候选人、HR 旁观面试，面试房间模块亦包括面试的回放。

#### 界面设计

前段代码使用了 Vue.js 作为基础框架，为了一方面减轻在界面设计上的工作量，另一方面提升界面设计的美观度，我们使用了 Vuetify.js 作为前端 UI 库，Vuetify.js 是一个基于 Material Design 设计规范的 Vue 的语义化组件框架，提供了整洁、语义化和可重用的组件。

管理平台主要包括两类界面：登录界面和控制台界面。

登录界面由居中的登录框构成，简单大方，符合当前去除冗余、厚重和繁杂装饰效果，让“信息”本身作为核心被凸显的**扁平化**设计理念。

控制台界面主要由上方的网站标题、左侧的导航栏和中部的内容区域构成。左侧的导航栏的折叠或展开既能手动控制，也能根据浏览器窗口的宽度自动调节，从而保证中部的内容区域在不同的浏览器窗口宽度下都能有较好的展示面积。

左侧的导航栏包括两个部分：“业务管理”部分和“其他”部分。“业务管理”部分，顾名思义，提供了管理面试平台的入口，“其他”部分则是一些和面试管理关于的内容，如“个人信息”页面、“密码修改”页面等。导航栏的这种划分保证了它的整洁、清晰。

我们的 UI 设计具有高度的一致性，不同的用户、每个用户的不同页面，都保持着整体布局、风格的一致性。

我们的面试平台对移动端也有很好的支持，这主要源于我们使用的 Vuetify.js 的响应式布局，使得页面可以轻松在不同的方向和屏幕尺寸间转换。

#### 功能设计：面试房间

面试房间是和控制台相对独立的一个模块。

面试房间的整体布局是：左上方为代码区，用于考察代码编写、代码填空；右上为视频聊天区；左下为白板，有多种笔迹可供绘图；右下为文字聊天区。相邻区域的边界可以使用鼠标来自由调节，从而保证面试官和候选人能根据自己的喜好、当前面试的重点内容来自由调节各个区域的面积。

面试房间的核心是消息的传输和同步：文字聊天内容、视频聊天内容、白板内容、代码内容都需要保证即时的同步，为了完成这个核心功能，我们经过广泛调研，选择使用 WebRTC 技术，WebRTC（Web Real-Time Communication）是一个提供实时通信的框架，受到 Apple、Goolge、Microsoft 等“大厂”的支持，进入了 W3C 推荐标准。

为了减轻我们的工作量，我们决定使用对 WebRTC 做了深度封装的框架，最终我们选择了其中之一 [RTCMultiConnection](https://github.com/muaz-khan/RTCMultiConnection)。我们将文字聊天内容、白板内容、代码内容都看成文本信息，视频聊天内容是媒体流信息，借助 [RTCMultiConnection](https://github.com/muaz-khan/RTCMultiConnection) 对文本信息、媒体流信息良好的支持，我们解决了面试过程中的信息同步问题。

具体来说，我们基于 [RTCMultiConnection](https://github.com/muaz-khan/RTCMultiConnection) 建立了 WebRTC Signaling 服务器：https://rtc.yusanshi.com/，开始面试时，面试的各个参与者通过 Signaling 服务器建立 Peer2Peer 连接，之后的文本信息、媒体流信息通过 WebRTC 技术直接在各个参与者之间传输。

对于面试的回放功能，在面试的过程中，我们将信息实时发送到后端服务器，后端服务器记录内容和时间戳，在面试回放的时候按照时间戳来返回信息即可。

**面试房间流程图：**

![](面试房间流程图.jpg)

#### 其他

**TypeScript**

我们在前端代码中使用了 TypeScript，其静态类型带来了很多好处，如：

- 自动完成；
- 类型一定程度上可作为文档；
- 基本杜绝 JavaScript 的弱类型带来的问题（如字符串和数字混用时的一些问题）。

#### 详细设计

| 页面     | 首页                                                    | 超管控制台                                                   | HR 控制台                                                    | 面试官控制台                                     | 面试房间                                                     |
| -------- | ------------------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------ | ------------------------------------------------------------ |
| 地址     | `/`                                                     | `/console`                                                   | `/console`                                                   | `/console`                                       | `/interview/<id>?token=XXXXX`                                |
| 访问控制 | 无                                                      | 需已用超管账号密码登录                                       | 需已用 HR 账号密码登录                                       | 需已用面试官账号密码登录                         | 无 token 或无效 token 禁止访问（共有三个 token）             |
| 内容一   | 登录（邮箱框、密码框）                                  | 个人密码修改（旧密码、新密码）                               | 个人密码修改（旧密码、新密码）                               | 个人密码修改（旧密码、新密码）                   | 面试前：该场面试的信息（根据三类 token 区别显示，如 HR 的 token 要比候选人的 token 显示更多信息）；面试中：面试界面（根据三类 token 区别显示）；面试后：回溯界面（注意此时只有 HR 的 token 可用） |
| 内容二   | 其他不重要但是能充实首页的信息（如一些好看的 Banner  ） | 查看所有用户信息（HR：邮箱、姓名、被分配的面试官、被分配的候选人；面试官：邮箱、姓名、空闲时间、被分配的 HR、被安排的面试；候选人：邮箱、姓名、被分配的 HR、被安排的面试、HR 给的申请结果） | 查看被分配的面试官和候选人（显示候选人的邮箱、被安排的面试及评分、评语） | 个人空闲时间查看和修改                           |                                                              |
| 内容三   |                                                         | 添加用户（根据 role 不同而单个或批量，可放在表格左上角；name 项只对候选人是必须的） | 设置候选人的申请结果（待定、通过、拒绝）。候选人的申请结果由HR根据候选人接受的面试的情况来做修改。默认是待定。即使申请结果被 HR 修改为通过或拒绝后，也还可以随时再改。 | 被安排的面试（这里的面试条目的超链接带有 token） |                                                              |
| 内容四   |                                                         | 添加分配（HR - 候选人间、HR - 面试官间，可放在每个用户条目中） | 添加面试（面试双方的 id、面试开始时间和时长）                |                                                  |                                                              |
| 内容五   |                                                         | 查看题库                                                     | 自己安排的面试信息（<del>还未开始的面试显示重发通知邮件按钮</del>，正在进行的面试显示旁观按钮，已结束的面试显示回溯按钮；这里的面试条目的超链接带有 token） |                                                  |                                                              |
|          |                                                         | 添加题目                                                     |                                                              |                                                  |                                                              |



### 数据库设计

#### `User`

| 列名        | 类型    | 备注                                                         |
| ----------- | ------- | ------------------------------------------------------------ |
| id          | integer | unique（自动生成即可）                                       |
| email       | string  | unique                                                       |
| name        | string  |                                                              |
| pass_sha256 | string  | 暂时用 SHA256 哈希后的密码 `hashlib.sha256(b'foo').hexdigest()` |
| role        | integer | [0, 1, 2, 3] => [admin, HR, interviewer, interviewee]        |

##### `Interviewer`

| 列名      | 类型    | 备注                                                         |
| --------- | ------- | ------------------------------------------------------------ |
| id        | integer | [OneToOneField] → User                                       |
| free_time | string  | 该面试官自己在系统中填写的空闲时间（被转换成字符串的JSON数据),严格遵循格式XXXX.XX.XX-15:30-16：00格式便于数据库部分进行格式检查 |

#### `UserLogin`

| 列名  | 类型 | 备注                                         |
| ----- | ---- | -------------------------------------------- |
| user  |      | 外码 → User                                  |
| token | UUID | 登录时给一个 token，用于验证身份，登出时删去 |

#### `Interviewee`

| 列名               | 类型    | 备注                                                         |
| ------------------ | ------- | ------------------------------------------------------------ |
| email              | string  | 主键                                                         |
| name               | string  |                                                              |
| application_result | integer | map: ['Pending', 'Approved', 'Rejected']，是 HR 给的面试结果，初始值应是 'Pending'。注意这里的结果和单场面试结果的区别：这里的结果是申请的最终结果，HR 自行安排面试的次数，TA 根据所有的单场面试的结果来决定这里的最终结果 |

#### `HRAssignInterviewer`

| 列名        | 类型    | 备注               |
| ----------- | ------- | ------------------ |
| hr          | integer | 外码 → User        |
| interviewer | integer | 外码 → Interviewer |

#### `HRAssignInterviewee`

| 列名        | 类型    | 备注               |
| ----------- | ------- | ------------------ |
| hr          | integer | 外码 → User        |
| interviewee | string  | 外码 → Interviewee |

#### `Interview`

| 列名              | 类型    | 备注                            |
| ----------------- | ------- | ------------------------------- |
| id                | integer | unique（自动生成即可）          |
| hr                | integer | 外码 → User                     |
| interviewer       | integer | 外码 → Interviewer              |
| interviewee       | string  | 外码 → Interviewee              |
| interviewer_token | UUID    | `default=uuid.uuid4`            |
| interviewee_token | UUID    | `default=uuid.uuid4`            |
| password          | string  | 连接密码，插入新记录时随机生成  |
| start_time        | time    |                                 |
| length            | integer | 单位分钟，> 0，建表时默认 30    |
| status            | string  | ['upcoming', 'active', 'ended'] |

#### `InterviewComment`

一个 interview 有 comment 说明已经结束。

| 列名      | 类型    | 备注                                                         |
| --------- | ------- | ------------------------------------------------------------ |
| interview |         | [[OneToOneField](https://docs.djangoproject.com/en/3.0/ref/models/fields/#django.db.models.OneToOneField)] → Interview |
| rate      | integer | 0--4 ⇒ ['S', 'A', 'B', 'C', 'D']                             |
| comment   | string  | 面试官评价                                                   |

#### `History`

| 列名      | 类型     | 备注                                     |
| --------- | -------- | ---------------------------------------- |
| interview | integer  | 外码 → Interview                         |
| type      | string   | ["chat", "whiteboard", "code"]           |
| time      | datetime | `default=datetime.datetime.utcnow`       |
| data      | string   | JSON 字符串，格式根据 history 的类型决定 |

#### `Problem`

> 它的列根据具体选用的 Online Judge 来定。

| 列名 | 类型    | 备注                   |
| ---- | ------- | ---------------------- |
| id   | integer | unique（自动生成即可） |

[OneToOneField]: https://docs.djangoproject.com/en/3.0/ref/models/fields/#django.db.models.OneToOneField



### 接口设计

接口文档地址：<https://i-m-feeling-lucky.github.io/> 



### 维护设计

#### 备份

为保障在数据丢失的情况下，能恢复重要数据，因此，在数据库中的数据发生变化后，将及时对重要的数据进行备份。为不影响业务处理的正常进行，数据备份将采用多种备份方法，将完全备份这类占用服务资源高的备份设置在业务处理的空闲时间段，而将日志备份这类占用服务资源少的备份方法应用在业务处理的高峰，但却需要及时备份的时候；充分考虑故障出现时，业务处理可以接受的停机时间，不同的备份方法，需要的还原时间不同，因此，在照顾备份对业务处理影响的同时，将考虑还原的时间。考虑到灾难性数据丢失造成的影响，对于重要的数据，将定期备份数据库到多种介质和多个地方。

#### 维护窗口期

维护将选择在运行的低谷期进行，并提前通知受影响的用户（企业）。